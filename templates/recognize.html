{% extends "base.html" %}

{% block title %}ƒêi·ªÉm danh - Face Recognition System{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">üéØ ƒêi·ªÉm danh khu√¥n m·∫∑t</div>

    <div id="alertContainer"></div>

    <!-- Shift Selection -->
    <div class="shift-selection">
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label for="attendanceDate">üìÖ Ch·ªçn ng√†y (ch·ªâ Th·ª© 2, 4, 6)</label>
                <input type="date" id="attendanceDate" class="form-control">
                <small id="dateError" class="error-text" style="display: none;">
                    ‚ö†Ô∏è Ch·ªâ ƒë∆∞·ª£c ph√©p ƒëi·ªÉm danh v√†o Th·ª© 2, Th·ª© 4, Th·ª© 6
                </small>
            </div>

            <div class="form-group" style="flex: 1;">
                <label for="shiftSelect">‚è∞ Ch·ªçn ca tr·ª±c</label>
                <select id="shiftSelect" class="form-control">
                    <option value="1">Ca 1 (06:00 - 09:00)</option>
                    <option value="2">Ca 2 (09:00 - 12:00)</option>
                    <option value="3">Ca 3 (13:00 - 16:00)</option>
                    <option value="4">Ca 4 (16:00 - 19:00)</option>
                </select>
            </div>
        </div>

        <div id="selectedInfo" class="selected-info">
            <span id="selectedDateText">-</span> | <span id="selectedShiftText">Ca 1</span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 1.5rem;">
        <!-- Camera Feed -->
        <div>
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay"></canvas>
            </div>

            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button id="startBtn" class="btn btn-success" style="flex: 1;" disabled>
                    ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ƒëi·ªÉm danh
                </button>
                <button id="stopBtn" class="btn btn-danger" style="flex: 1;" disabled>
                    ‚è∏Ô∏è D·ª´ng
                </button>
            </div>
        </div>

        <!-- Recognition Results -->
        <div>
            <h3 style="margin-bottom: 1rem;">üìã K·∫øt qu·∫£ ƒëi·ªÉm danh</h3>
            <div id="resultsContainer" style="max-height: 500px; overflow-y: auto;">
                <p style="color: var(--text-muted); font-style: italic;">Ch∆∞a c√≥ k·∫øt qu·∫£</p>
            </div>
        </div>
    </div>
</div>

<style>
    #overlay {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
    }

    .shift-selection {
        background: var(--dark-lighter);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid var(--border);
    }

    .form-row {
        display: flex;
        gap: 1.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--dark);
        color: var(--text);
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-control:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-text {
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: block;
    }

    .selected-info {
        text-align: center;
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
        font-weight: 600;
        color: var(--primary);
    }

    .result-item {
        background: rgba(51, 65, 85, 0.5);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        animation: slideIn 0.3s ease;
    }

    .result-item.success {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1);
    }

    .result-item.duplicate {
        border-color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .result-item.unknown {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
    }

    .result-name {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .result-time {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .result-status {
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    /* ===================== CONFIG ===================== */
    const CONFIDENCE_THRESHOLD = 0.7;
    const RECOGNIZE_INTERVAL_MS = 2000;

    // Allowed weekdays: Monday, Wednesday, Friday
    const allowedWeekdays = [1, 3, 5]; // JS: 0=Sun

    /* ===================== DOM ===================== */
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const alertContainer = document.getElementById('alertContainer');
    const attendanceDate = document.getElementById('attendanceDate');
    const shiftSelect = document.getElementById('shiftSelect');
    const dateError = document.getElementById('dateError');
    const selectedDateText = document.getElementById('selectedDateText');
    const selectedShiftText = document.getElementById('selectedShiftText');

    /* ===================== STATE ===================== */
    let stream = null;
    let recognitionInterval = null;
    let isRecognizing = false;

    /* ===================== UTILS ===================== */
    function showAlert(message, type = 'info') {
        alertContainer.innerHTML = '';
        const div = document.createElement('div');
        div.className = `alert alert-${type}`;
        div.textContent = message;
        alertContainer.appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }

    function getWeekdayName(date) {
        return ["Ch·ªß nh·∫≠t", "Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7"][date.getDay()];
    }

    function isAllowedDate(dateStr) {
        return allowedWeekdays.includes(new Date(dateStr).getDay());
    }

    /* ===================== DATE / SHIFT ===================== */
    function updateDateSelection() {
        const value = attendanceDate.value;
        if (!value) {
            startBtn.disabled = true;
            selectedDateText.textContent = '-';
            return;
        }

        const date = new Date(value);
        const weekday = getWeekdayName(date);
        selectedDateText.textContent = `${weekday}, ${value}`;

        if (!isAllowedDate(value)) {
            startBtn.disabled = true;
            attendanceDate.style.borderColor = 'var(--danger)';
            dateError.style.display = 'block';
            showAlert(`‚ùå ${weekday} kh√¥ng ƒë∆∞·ª£c ph√©p ƒëi·ªÉm danh`, 'error');
            return;
        }

        dateError.style.display = 'none';
        attendanceDate.style.borderColor = 'var(--success)';
        startBtn.disabled = false;
    }

    function updateShiftSelection() {
        const map = {
            1: 'Ca 1 (06:00 - 09:00)',
            2: 'Ca 2 (09:00 - 12:00)',
            3: 'Ca 3 (13:00 - 16:00)',
            4: 'Ca 4 (16:00 - 19:00)'
        };
        selectedShiftText.textContent = map[shiftSelect.value] || '-';
    }

    function setDefaultDate() {
        const today = new Date();
        for (let i = 0; i < 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            if (allowedWeekdays.includes(d.getDay())) {
                attendanceDate.value = d.toISOString().split('T')[0];
                break;
            }
        }
        updateDateSelection();
    }

    /* ===================== CAMERA ===================== */
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
            };
            showAlert('üì∑ Camera s·∫µn s√†ng', 'success');
        } catch {
            showAlert('‚ùå Kh√¥ng th·ªÉ m·ªü camera', 'error');
        }
    }

    /* ===================== DRAW ===================== */
    function drawFaceBox(face) {
        const ctx = overlay.getContext('2d');
        const { top, left, right, bottom, name, confidence, status } = face;
        const colorMap = {
            success: '#10b981',
            already_marked: '#3b82f6',
            unknown: '#ef4444'
        };

        ctx.strokeStyle = colorMap[status] || '#f59e0b';
        ctx.lineWidth = 3;
        ctx.strokeRect(left, top, right - left, bottom - top);

        const label = name === 'Unknown'
            ? 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c'
            : `${name} (${Math.round(confidence * 100)}%)`;

        ctx.font = 'bold 14px sans-serif';
        ctx.fillStyle = ctx.strokeStyle;
        ctx.fillRect(left, top - 24, ctx.measureText(label).width + 12, 22);
        ctx.fillStyle = '#fff';
        ctx.fillText(label, left + 6, top - 8);
    }

    function addResult(face) {
        const div = document.createElement('div');
        div.className = `result-item ${face.status}`;
        div.innerHTML = `
        <div>${face.status === 'success' ? '‚úÖ' : '‚ùå'} ${face.name}</div>
        <div>‚è∞ ${new Date().toLocaleTimeString('vi-VN')}</div>
        <div>${face.message}</div>
        ${face.confidence ? `<small>ƒê·ªô tin c·∫≠y: ${(face.confidence * 100).toFixed(1)}%</small>` : ''}
    `;
        resultsContainer.prepend(div);
        while (resultsContainer.children.length > 15)
            resultsContainer.removeChild(resultsContainer.lastChild);
    }

    /* ===================== CORE LOGIC ===================== */
    async function recognizeFrame() {
        if (!isRecognizing) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
        const formData = new FormData();
        formData.append('image', blob);
        formData.append('date', attendanceDate.value);
        formData.append('shift', shiftSelect.value);

        const res = await fetch('/api/recognize', { method: 'POST', body: formData });
        const data = await res.json();

        overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);

        if (!res.ok) {
            showAlert(data.detail || 'L·ªói nh·∫≠n di·ªán', 'error');
            return;
        }

        data.faces?.forEach(face => {
            if (!face.confidence || face.confidence < CONFIDENCE_THRESHOLD) {
                face.status = 'unknown';
                face.name = 'Unknown';
                face.message = 'ƒê·ªô tin c·∫≠y th·∫•p';
            }
            drawFaceBox(face);
            addResult(face);
        });
    }

    /* ===================== CONTROL ===================== */
    function startRecognition() {
        if (!attendanceDate.value || !isAllowedDate(attendanceDate.value)) {
            showAlert('‚ùå Ng√†y kh√¥ng h·ª£p l·ªá', 'error');
            return;
        }
        isRecognizing = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        attendanceDate.disabled = true;
        shiftSelect.disabled = true;
        recognitionInterval = setInterval(recognizeFrame, RECOGNIZE_INTERVAL_MS);
    }

    function stopRecognition() {
        isRecognizing = false;
        clearInterval(recognitionInterval);
        overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        attendanceDate.disabled = false;
        shiftSelect.disabled = false;
    }

    /* ===================== INIT ===================== */
    startBtn.onclick = startRecognition;
    stopBtn.onclick = stopRecognition;
    attendanceDate.onchange = updateDateSelection;
    shiftSelect.onchange = updateShiftSelection;

    setDefaultDate();
    updateShiftSelection();
    startCamera();

    window.onbeforeunload = () => stream?.getTracks().forEach(t => t.stop());
</script>
{% endblock %}