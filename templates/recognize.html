{% extends "base.html" %}

{% block title %}ƒêi·ªÉm danh - Face Recognition System{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">üéØ ƒêi·ªÉm danh khu√¥n m·∫∑t</div>

    <div id="alertContainer"></div>

    <!-- Shift Selection -->
    <div class="shift-selection">
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label for="attendanceDate">üìÖ Ch·ªçn ng√†y (ch·ªâ Th·ª© 2, 4, 6)</label>
                <input type="date" id="attendanceDate" class="form-control">
                <small id="dateError" class="error-text" style="display: none;">
                    ‚ö†Ô∏è Ch·ªâ ƒë∆∞·ª£c ph√©p ƒëi·ªÉm danh v√†o Th·ª© 2, Th·ª© 4, Th·ª© 6
                </small>
            </div>

            <div class="form-group" style="flex: 1;">
                <label for="shiftSelect">‚è∞ Ch·ªçn ca tr·ª±c</label>
                <select id="shiftSelect" class="form-control">
                    <option value="1">Ca 1 (06:00 - 09:00)</option>
                    <option value="2">Ca 2 (09:00 - 12:00)</option>
                    <option value="3">Ca 3 (13:00 - 16:00)</option>
                    <option value="4">Ca 4 (16:00 - 19:00)</option>
                </select>
            </div>
        </div>

        <div id="selectedInfo" class="selected-info">
            <span id="selectedDateText">-</span> | <span id="selectedShiftText">Ca 1</span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 1.5rem;">
        <!-- Camera Feed -->
        <div>
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay"></canvas>
            </div>

            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button id="startBtn" class="btn btn-success" style="flex: 1;" disabled>
                    ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ƒëi·ªÉm danh
                </button>
                <button id="stopBtn" class="btn btn-danger" style="flex: 1;" disabled>
                    ‚è∏Ô∏è D·ª´ng
                </button>
            </div>
        </div>

        <!-- Recognition Results -->
        <div>
            <h3 style="margin-bottom: 1rem;">üìã K·∫øt qu·∫£ ƒëi·ªÉm danh</h3>
            <div id="resultsContainer" style="max-height: 500px; overflow-y: auto;">
                <p style="color: var(--text-muted); font-style: italic;">Ch∆∞a c√≥ k·∫øt qu·∫£</p>
            </div>
        </div>
    </div>
</div>

<style>
    #overlay {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
    }

    .shift-selection {
        background: var(--dark-lighter);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid var(--border);
    }

    .form-row {
        display: flex;
        gap: 1.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--dark);
        color: var(--text);
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-control:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-text {
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: block;
    }

    .selected-info {
        text-align: center;
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
        font-weight: 600;
        color: var(--primary);
    }

    .result-item {
        background: rgba(51, 65, 85, 0.5);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        animation: slideIn 0.3s ease;
    }

    .result-item.success {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1);
    }

    .result-item.duplicate {
        border-color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .result-item.unknown {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
    }

    .result-name {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .result-time {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .result-status {
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const alertContainer = document.getElementById('alertContainer');
    const attendanceDate = document.getElementById('attendanceDate');
    const shiftSelect = document.getElementById('shiftSelect');
    const dateError = document.getElementById('dateError');
    const selectedDateText = document.getElementById('selectedDateText');
    const selectedShiftText = document.getElementById('selectedShiftText');

    let stream = null;
    let recognitionInterval = null;
    let isRecognizing = false;

    // Allowed weekdays: 0=Monday, 2=Wednesday, 4=Friday
    const allowedWeekdays = [1, 3, 5]; // In JS: 0=Sunday, 1=Monday, 2=Tuesday, etc.
    // So Monday=1, Wednesday=3, Friday=5 in JavaScript

    // Show alert message
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Get Vietnamese weekday name
    function getWeekdayName(date) {
        const weekday = date.getDay();
        const names = ["Ch·ªß nh·∫≠t", "Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7"];
        return names[weekday];
    }

    // Check if date is allowed
    function isAllowedDate(dateStr) {
        const date = new Date(dateStr);
        const weekday = date.getDay();
        return allowedWeekdays.includes(weekday);
    }

    // Update date selection
    function updateDateSelection() {
        const dateStr = attendanceDate.value;

        if (!dateStr) {
            dateError.style.display = 'none';
            startBtn.disabled = true;
            selectedDateText.textContent = '-';
            return;
        }

        const date = new Date(dateStr);
        const weekdayName = getWeekdayName(date);
        selectedDateText.textContent = `${weekdayName}, ${dateStr}`;

        if (isAllowedDate(dateStr)) {
            dateError.style.display = 'none';
            startBtn.disabled = false;
            attendanceDate.style.borderColor = 'var(--success)';
        } else {
            dateError.style.display = 'block';
            startBtn.disabled = true;
            attendanceDate.style.borderColor = 'var(--danger)';
            showAlert(`‚ùå ${weekdayName} kh√¥ng ƒë∆∞·ª£c ph√©p ƒëi·ªÉm danh. Ch·ªâ ƒë∆∞·ª£c th·ª© 2, 4, 6.`, 'error');
        }
    }

    // Update shift selection
    function updateShiftSelection() {
        const shiftId = shiftSelect.value;
        const shiftNames = {
            '1': 'Ca 1 (06:00 - 09:00)',
            '2': 'Ca 2 (09:00 - 12:00)',
            '3': 'Ca 3 (13:00 - 16:00)',
            '4': 'Ca 4 (16:00 - 19:00)'
        };
        selectedShiftText.textContent = shiftNames[shiftId];
    }

    // Set default date to today (if allowed) or next allowed day
    function setDefaultDate() {
        const today = new Date();
        let targetDate = today;

        // Find next allowed day
        for (let i = 0; i < 7; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(today.getDate() + i);
            if (allowedWeekdays.includes(checkDate.getDay())) {
                targetDate = checkDate;
                break;
            }
        }

        attendanceDate.value = targetDate.toISOString().split('T')[0];
        updateDateSelection();
    }

    // Start camera
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 }
            });
            video.srcObject = stream;

            video.addEventListener('loadedmetadata', () => {
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
            });

            showAlert('Camera ƒë√£ s·∫µn s√†ng! Ch·ªçn ng√†y v√† ca tr·ª±c r·ªìi b·∫Øt ƒë·∫ßu ƒëi·ªÉm danh.', 'success');
        } catch (error) {
            console.error('Camera error:', error);
            showAlert('Kh√¥ng th·ªÉ truy c·∫≠p camera!', 'error');
        }
    }

    // Draw bounding box with label
    function drawFaceBox(face) {
        const ctx = overlay.getContext('2d');
        const { top, right, bottom, left, name, confidence, status } = face;

        const width = right - left;
        const height = bottom - top;

        // Choose color based on status
        let color = '#f59e0b'; // Orange for unknown
        if (status === 'success') color = '#10b981'; // Green for success
        else if (status === 'already_marked') color = '#3b82f6'; // Blue for duplicate

        // Draw rectangle
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.strokeRect(left, top, width, height);

        // Draw label background
        const label = name !== 'Unknown'
            ? `${name} (${(confidence * 100).toFixed(0)}%)`
            : 'Kh√¥ng nh·∫≠n di·ªán';

        ctx.font = 'bold 14px Inter, sans-serif';
        const textWidth = ctx.measureText(label).width;

        ctx.fillStyle = color;
        ctx.fillRect(left, top - 25, textWidth + 16, 25);

        // Draw label text
        ctx.fillStyle = '#ffffff';
        ctx.fillText(label, left + 8, top - 8);
    }

    // Add result to sidebar
    function addResult(face) {
        const { name, status, message, confidence } = face;

        const resultDiv = document.createElement('div');
        resultDiv.className = `result-item ${status}`;

        const now = new Date().toLocaleTimeString('vi-VN');
        const dateStr = attendanceDate.value;
        const shiftName = selectedShiftText.textContent;

        let icon = '‚ùì';
        if (status === 'success') icon = '‚úÖ';
        else if (status === 'already_marked') icon = '‚ö†Ô∏è';
        else if (status === 'unknown') icon = '‚ùå';

        resultDiv.innerHTML = `
            <div class="result-name">${icon} ${name}</div>
            <div class="result-time">‚è∞ ${now} | üìÖ ${dateStr}</div>
            <div class="result-status">${message}</div>
            ${confidence > 0 ? `<div style="color: var(--text-muted); font-size: 0.85rem;">ƒê·ªô tin c·∫≠y: ${(confidence * 100).toFixed(1)}%</div>` : ''}
        `;

        // Add to top of results
        if (resultsContainer.firstChild && resultsContainer.firstChild.tagName !== 'P') {
            resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
        } else {
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resultDiv);
        }

        // Keep only last 15 results
        while (resultsContainer.children.length > 15) {
            resultsContainer.removeChild(resultsContainer.lastChild);
        }
    }

    // Capture and send frame to backend
    async function recognizeFrame() {
        if (!isRecognizing) return;

        const dateStr = attendanceDate.value;
        const shift = parseInt(shiftSelect.value);

        if (!dateStr || !shift) {
            showAlert('Vui l√≤ng ch·ªçn ng√†y v√† ca tr·ª±c!', 'error');
            stopRecognition();
            return;
        }

        try {
            // Create canvas to capture frame
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0);

            // Convert to blob
            const blob = await new Promise(resolve => {
                tempCanvas.toBlob(resolve, 'image/jpeg', 0.8);
            });

            // Send to backend with date and shift
            const formData = new FormData();
            formData.append('image', blob, 'frame.jpg');
            formData.append('date', dateStr);
            formData.append('shift', shift);

            const response = await fetch('/api/recognize', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            // Clear overlay
            const ctx = overlay.getContext('2d');
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            if (!response.ok) {
                showAlert(`‚ùå ${data.detail}`, 'error');
                return;
            }

            // Draw boxes for each detected face
            if (data.faces && data.faces.length > 0) {
                data.faces.forEach(face => {
                    drawFaceBox(face);
                    addResult(face);
                });
            }

        } catch (error) {
            console.error('Recognition error:', error);
        }
    }

    // Start recognition
    function startRecognition() {
        if (!attendanceDate.value || !isAllowedDate(attendanceDate.value)) {
            showAlert('Vui l√≤ng ch·ªçn ng√†y h·ª£p l·ªá (Th·ª© 2, 4, 6)!', 'error');
            return;
        }

        isRecognizing = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        attendanceDate.disabled = true;
        shiftSelect.disabled = true;

        showAlert('üéØ ƒêang ƒëi·ªÉm danh... ƒê·ª©ng tr∆∞·ªõc camera ƒë·ªÉ nh·∫≠n di·ªán.', 'info');

        // Recognize every 2 seconds
        recognitionInterval = setInterval(recognizeFrame, 2000);
    }

    // Stop recognition
    function stopRecognition() {
        isRecognizing = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        attendanceDate.disabled = false;
        shiftSelect.disabled = false;

        if (recognitionInterval) {
            clearInterval(recognitionInterval);
        }

        // Clear overlay
        const ctx = overlay.getContext('2d');
        ctx.clearRect(0, 0, overlay.width, overlay.height);

        showAlert('‚è∏Ô∏è ƒê√£ d·ª´ng ƒëi·ªÉm danh', 'info');
    }

    // Event listeners
    startBtn.addEventListener('click', startRecognition);
    stopBtn.addEventListener('click', stopRecognition);
    attendanceDate.addEventListener('change', updateDateSelection);
    shiftSelect.addEventListener('change', updateShiftSelection);

    // Initialize
    setDefaultDate();
    updateShiftSelection();
    startCamera();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (recognitionInterval) {
            clearInterval(recognitionInterval);
        }
    });
</script>
{% endblock %}