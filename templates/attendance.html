{% extends "base.html" %}

{% block title %}L·ªãch s·ª≠ ƒëi·ªÉm danh - Face Recognition System{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">üìã L·ªãch s·ª≠ ƒëi·ªÉm danh</div>

    <!-- Filters -->
    <div class="filters">
        <div class="filter-row">
            <div class="filter-group">
                <label for="filterDate">üìÖ L·ªçc theo ng√†y</label>
                <input type="date" id="filterDate" class="form-control">
            </div>

            <div class="filter-group">
                <label for="filterShift">‚è∞ L·ªçc theo ca</label>
                <select id="filterShift" class="form-control">
                    <option value="">T·∫•t c·∫£ ca</option>
                    <option value="1">Ca 1 (06:00 - 09:00)</option>
                    <option value="2">Ca 2 (09:00 - 12:00)</option>
                    <option value="3">Ca 3 (13:00 - 16:00)</option>
                    <option value="4">Ca 4 (16:00 - 19:00)</option>
                </select>
            </div>

            <div class="filter-actions">
                <button id="refreshBtn" class="btn btn-primary">
                    üîÑ L√†m m·ªõi
                </button>
                <button id="clearFilterBtn" class="btn btn-secondary">
                    ‚úñÔ∏è X√≥a b·ªô l·ªçc
                </button>
                <button id="deleteAllBtn" class="btn btn-danger" style="margin-left: auto;">
                    üóëÔ∏è X√≥a t·∫•t c·∫£
                </button>
            </div>
        </div>

        <!-- Stats summary -->
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-label">T·ªïng s·ªë:</span>
                <span class="stat-value" id="totalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ca 1:</span>
                <span class="stat-value" id="shift1Count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ca 2:</span>
                <span class="stat-value" id="shift2Count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ca 3:</span>
                <span class="stat-value" id="shift3Count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ca 4:</span>
                <span class="stat-value" id="shift4Count">0</span>
            </div>
        </div>
    </div>

    <div id="loadingSpinner" class="spinner"></div>

    <div id="tableContainer" style="display: none;">
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>·∫¢nh</th>
                    <th>T√™n</th>
                    <th>M√£ s·ªë</th>
                    <th>Ng√†y</th>
                    <th>Ca tr·ª±c</th>
                    <th>Th·ªùi gian</th>
                    <th>ƒê·ªô tin c·∫≠y</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>

        <div id="emptyMessage" style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
            üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh
        </div>
    </div>
</div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
    <div id="caption"></div>
</div>

<style>
    .filters {
        background: var(--dark-lighter);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid var(--border);
    }

    .filter-row {
        display: flex;
        gap: 1.5rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 150px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
    }

    .filter-actions {
        display: flex;
        gap: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--dark);
        color: var(--text);
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
    }

    .stats-row {
        display: flex;
        gap: 1.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stat-label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .stat-value {
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1rem;
    }

    .btn-secondary {
        background: var(--dark);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--dark-light);
    }

    .confidence-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .confidence-high {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
    }

    .confidence-medium {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
    }

    .confidence-low {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
    }

    .shift-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(99, 102, 241, 0.2);
        color: var(--primary);
    }

    table {
        margin-top: 1.5rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid var(--primary);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .user-avatar:hover {
        transform: scale(1.1);
    }

    .no-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--dark-lighter);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: var(--text-muted);
        border: 1px solid var(--border);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        padding-top: 50px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.9);
    }

    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
        animation: zoom 0.6s;
    }

    @keyframes zoom {
        from {
            transform: scale(0)
        }

        to {
            transform: scale(1)
        }
    }

    .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const refreshBtn = document.getElementById('refreshBtn');
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const filterDate = document.getElementById('filterDate');
    const filterShift = document.getElementById('filterShift');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const tableContainer = document.getElementById('tableContainer');
    const tableBody = document.getElementById('tableBody');
    const emptyMessage = document.getElementById('emptyMessage');

    // Modal elements
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    const span = document.getElementsByClassName("close")[0];

    span.onclick = function () {
        modal.style.display = "none";
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    function showImage(src) {
        if (!src) return;
        modal.style.display = "block";
        modalImg.src = src;
    }

    let attendanceData = [];

    // Format date for display
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('vi-VN', {
            weekday: 'short',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    // Format time for display
    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // Get confidence badge class
    function getConfidenceBadge(confidence) {
        const percent = confidence * 100;
        let badgeClass = 'confidence-low';

        if (percent >= 80) {
            badgeClass = 'confidence-high';
        } else if (percent >= 60) {
            badgeClass = 'confidence-medium';
        }

        return `<span class="confidence-badge ${badgeClass}">${percent.toFixed(1)}%</span>`;
    }

    // Get shift badge
    function getShiftBadge(shift, shiftName) {
        return `<span class="shift-badge">${shiftName || `Ca ${shift}`}</span>`;
    }

    // Update stats
    function updateStats(data) {
        document.getElementById('totalCount').textContent = data.length;

        const shiftCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };
        data.forEach(record => {
            if (record.shift && shiftCounts.hasOwnProperty(record.shift)) {
                shiftCounts[record.shift]++;
            }
        });

        document.getElementById('shift1Count').textContent = shiftCounts[1];
        document.getElementById('shift2Count').textContent = shiftCounts[2];
        document.getElementById('shift3Count').textContent = shiftCounts[3];
        document.getElementById('shift4Count').textContent = shiftCounts[4];
    }

    // Render table
    function renderTable(data) {
        tableBody.innerHTML = '';
        updateStats(data);

        if (data.length === 0) {
            emptyMessage.style.display = 'block';
            return;
        }

        emptyMessage.style.display = 'none';

        data.forEach((record, index) => {
            const imageHtml = record.image_url
                ? `<img src="${record.image_url}" class="user-avatar" onclick="showImage('${record.image_url}')" alt="${record.name}">`
                : `<div class="no-avatar">üì∑</div>`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${imageHtml}</td>
                <td><strong>${record.name}</strong></td>
                <td>${record.user_id}</td>
                <td>${formatDate(record.date)}</td>
                <td>${getShiftBadge(record.shift, record.shift_name)}</td>
                <td>${formatTime(record.timestamp)}</td>
                <td>${getConfidenceBadge(record.confidence || 0)}</td>
                <td>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="deleteRecord('${record.id}')">
                        üóëÔ∏è
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Load attendance data
    async function loadAttendance() {
        loadingSpinner.style.display = 'block';
        tableContainer.style.display = 'none';

        try {
            let url = '/api/attendance?limit=200';

            // Add filters
            if (filterDate.value) {
                url += `&date=${filterDate.value}`;
            }
            if (filterShift.value) {
                url += `&shift=${filterShift.value}`;
            }

            const response = await fetch(url);
            const data = await response.json();

            attendanceData = data.attendance || [];

            loadingSpinner.style.display = 'none';
            tableContainer.style.display = 'block';

            renderTable(attendanceData);

        } catch (error) {
            console.error('Error loading attendance:', error);
            loadingSpinner.style.display = 'none';
            tableContainer.style.display = 'block';
            emptyMessage.style.display = 'block';
            emptyMessage.textContent = '‚ùå L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!';
        }
    }

    // Clear filters
    function clearFilters() {
        filterDate.value = '';
        filterShift.value = '';
        loadAttendance();
    }

    // Delete single record
    async function deleteRecord(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?')) return;

        try {
            const response = await fetch(`/api/attendance/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadAttendance();
            } else {
                alert('Kh√¥ng th·ªÉ x√≥a b·∫£n ghi');
            }
        } catch (error) {
            console.error('Error deleting record:', error);
            alert('L·ªói khi x√≥a b·∫£n ghi');
        }
    }

    // Delete all records
    async function deleteAllRecords() {
        if (!confirm('C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò l·ªãch s·ª≠ ƒëi·ªÉm danh kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;

        try {
            const response = await fetch('/api/attendance/all', { method: 'DELETE' });
            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                loadAttendance();
            } else {
                alert('Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu');
            }
        } catch (error) {
            console.error('Error deleting all records:', error);
            alert('L·ªói khi x√≥a d·ªØ li·ªáu');
        }
    }

    // Event listeners
    refreshBtn.addEventListener('click', loadAttendance);
    clearFilterBtn.addEventListener('click', clearFilters);
    deleteAllBtn.addEventListener('click', deleteAllRecords);
    filterDate.addEventListener('change', loadAttendance);
    filterShift.addEventListener('change', loadAttendance);

    // Set today's date as default filter
    const today = new Date().toISOString().split('T')[0];
    filterDate.value = today;

    // Load data on page load
    loadAttendance();

    // Auto refresh every 30 seconds
    setInterval(loadAttendance, 30000);
</script>
{% endblock %}